# Redis Session Storage Guide

This guide explains how to check and manage session data stored in Redis.

## Prerequisites

- Redis server running (local or remote)
- `REDIS_URL` configured in your `.env` file

## Connecting to Redis

### Using Redis CLI

1. **Local Redis:**
   ```bash
   redis-cli
   ```

2. **Remote Redis:**
   ```bash
   redis-cli -h <host> -p <port> -a <password>
   # Or using URL format
   redis-cli -u redis://username:password@host:port
   ```

## Checking Session Data

### 1. List All Session Keys

Sessions are stored with the prefix `sess:` followed by the session ID.

```bash
# List all session keys
KEYS sess:*

# Count total sessions
KEYS sess:* | wc -l
```

### 2. View a Specific Session

```bash
# Get session data (replace SESSION_ID with actual session ID)
GET sess:SESSION_ID

# Example:
GET sess:abc123def456ghi789
```

### 3. View Session Data in Readable Format

Session data is stored as JSON. To view it formatted:

```bash
# Get and format session data
GET sess:SESSION_ID | python -m json.tool

# Or using jq (if installed)
GET sess:SESSION_ID | jq .
```

### 4. Check Session Expiration (TTL)

```bash
# Check time-to-live (in seconds)
TTL sess:SESSION_ID

# Returns:
# -1 = no expiration set
# -2 = key doesn't exist
# >0 = seconds until expiration
```

### 5. View All Active Sessions

```bash
# Get all session keys with their TTL
KEYS sess:* | xargs -I {} sh -c 'echo "{}: $(TTL {})"'
```

## Session Data Structure

A typical session in Redis looks like this:

```json
{
  "cookie": {
    "originalMaxAge": 7200000,
    "expires": "2024-01-15T10:30:00.000Z",
    "secure": false,
    "httpOnly": true,
    "path": "/"
  },
  "user": {
    "id": 1,
    "username": "john_doe",
    "email": "john@example.com",
    "isAdmin": false
  }
}
```

## Useful Redis Commands

### Monitor Session Activity

```bash
# Watch all Redis commands in real-time
MONITOR
```

### Delete a Specific Session

```bash
# Delete a session (forces user logout)
DEL sess:SESSION_ID
```

### Delete All Sessions

```bash
# ⚠️ WARNING: This logs out ALL users
FLUSHDB

# Or delete only session keys
KEYS sess:* | xargs DEL
```

### Find Sessions by User ID

```bash
# Get all sessions and filter for specific user
KEYS sess:* | xargs -I {} sh -c 'redis-cli GET {} | grep -q "user_id.*1" && echo {}'
```

## Session Key Format

- **Pattern:** `sess:<session_id>`
- **Session ID:** Generated by `express-session`, typically 24+ character string
- **Example:** `sess:abc123def456ghi789jkl012mno345pqr678`

## Important: Your Site Sessions Are Already Isolated!

**Q: When I check Redis, am I seeing sessions from my whole PC?**

**A: No!** Your BookConnect site sessions are already isolated. Here's why:

1. **Session Key Prefix:** All BookConnect sessions use the prefix `sess:` which is specific to your Express app
2. **Session Cookie Name:** Your app uses `bookconnect_sid` as the cookie name, which is unique to your site
3. **Redis Database:** By default, Redis uses database 0, and your sessions are stored there with the `sess:` prefix

**To see ONLY your site's sessions:**
```bash
# This shows ONLY BookConnect sessions (not other apps)
KEYS sess:*

# If you have multiple apps using Redis, you can use a more specific pattern
# But for BookConnect, sess:* is sufficient
```

**Note:** If you're running multiple Node.js apps on the same Redis instance, they might also use `sess:*` keys. To completely isolate:
- Use a different Redis database (SELECT 1, SELECT 2, etc.)
- Or use a different key prefix in your session configuration

## Session Expiration

- **Default TTL:** 2 hours (7200 seconds)
- **Configurable:** Set in `server.js` via `cookie.maxAge`
- **Auto-cleanup:** Redis automatically removes expired keys

## Troubleshooting

### No Sessions Found

1. Check if Redis is running:
   ```bash
   redis-cli PING
   # Should return: PONG
   ```

2. Verify `REDIS_URL` in `.env`:
   ```env
   REDIS_URL=redis://localhost:6379
   ```

3. Check server logs for connection errors

### Sessions Not Persisting

1. Verify Redis connection in server logs:
   ```
   ✅ Using Redis for session storage
   ```

2. Check Redis memory:
   ```bash
   redis-cli INFO memory
   ```

3. Check if Redis is configured to persist data:
   ```bash
   redis-cli CONFIG GET save
   ```

## Example Workflow

```bash
# 1. Connect to Redis
redis-cli

# 2. List all sessions
KEYS sess:*

# 3. Get a specific session
GET sess:abc123def456

# 4. Check expiration
TTL sess:abc123def456

# 5. View formatted JSON (if using jq)
GET sess:abc123def456 | jq .

# 6. Delete expired sessions manually (if needed)
# Redis auto-deletes expired keys, but you can force cleanup:
KEYS sess:* | xargs -I {} sh -c 'if [ $(TTL {}) -lt 0 ]; then DEL {}; fi'
```

## Security Notes

- Session data contains sensitive user information
- Never expose Redis to the internet without authentication
- Use Redis AUTH password in production
- Consider using Redis ACLs for fine-grained access control
- Session IDs should be kept secret (they're in cookies)

## Production Recommendations

1. **Enable Redis AUTH:**
   ```bash
   # In redis.conf
   requirepass your_strong_password
   ```

2. **Use Redis Sentinel or Cluster** for high availability

3. **Monitor Redis:**
   ```bash
   redis-cli --stat
   ```

4. **Set up alerts** for memory usage and connection failures

5. **Regular backups** of Redis data (if needed for session recovery)

